name: Run Tests
on:
  push:
  workflow_dispatch:
jobs:
  ast-regression:
    runs-on: ubuntu-latest

    env:
      VERIFY_BRANCH: verify_branch
      TEST_SCRIPTS_DIR: test/parser_samples
      CS_BIN_NAME: csprintast

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake p7zip-full
      - name: Prepare AST regression scripts
        run: |
          set -euo pipefail

          echo "=== AST Corpus Setup ==="
          echo "TEST_SCRIPTS_DIR = $TEST_SCRIPTS_DIR"
          echo "RUNNER_TEMP      = $RUNNER_TEMP"
          echo "PWD              = $(pwd)"
          echo

          mkdir -p "$TEST_SCRIPTS_DIR"

          if [ -z "${AST_CORPUS_REPO:-}" ] || [ -z "${AST_CORPUS_TOKEN:-}" ]; then
            echo "No AST_CORPUS_REPO / AST_CORPUS_TOKEN; using in-repo tests only."
            exit 0
          fi

          echo "=== Cloning AST corpus repo ==="
          git clone --depth 1 "https://${AST_CORPUS_TOKEN}@${AST_CORPUS_REPO}" "$RUNNER_TEMP/ast_corpus_repo"

          echo "Repository cloned to:"
          echo "$RUNNER_TEMP/ast_corpus_repo"
          ls -al "$RUNNER_TEMP/ast_corpus_repo" || true
          echo

          echo "Searching for .7z bundles:"          
          shopt -s nullglob
          bundles=( $RUNNER_TEMP/ast_corpus_repo/*.7z )
          printf 'Found %d bundles\n' "${#bundles[@]}"
          printf 'Bundle list:\n'
          printf '  %s\n' "${bundles[@]:-<none>}"
          echo

          if [ ${#bundles[@]} -eq 0 ]; then
            echo "No .7z bundles found in corpus repo root; nothing to extract."
            exit 0
          fi

          for bundle in "${bundles[@]}"; do
            echo "Extracting bundle: $bundle"
            7z x -p"$AST_CORPUS_PASSWORD" -y -bb3 -bso1 "$bundle" -o"$TEST_SCRIPTS_DIR"
          done
        env:
          AST_CORPUS_REPO:      ${{ secrets.AST_CORPUS_REPO }}
          AST_CORPUS_TOKEN:     ${{ secrets.AST_CORPUS_TOKEN }}
          AST_CORPUS_PASSWORD:  ${{ secrets.AST_CORPUS_PASSWORD }}

      - name: Run AST regression script
        run: |
          ./tools/check_ast_regression.sh
